<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJ Network - AI Companion Network</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        /* Auth Container */
        .auth-container {
            display: flex;
            height: 100vh;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        }

        .auth-card {
            background: #202123;
            border: 1px solid #2f2f2f;
            border-radius: 8px;
            padding: 40px;
            width: 400px;
            max-width: 90vw;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-title {
            font-size: 32px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: #8e8ea0;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 6px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px 16px;
            background: #10a37f;
            border: none;
            border-radius: 6px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #0d8c6b;
        }

        .btn-primary:disabled {
            background: #3f3f3f;
            cursor: not-allowed;
        }

        .auth-switch {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: #8e8ea0;
        }

        .auth-switch a {
            color: #10a37f;
            text-decoration: none;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #f93a37;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #10a37f;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* MJ Network UI - Hidden initially */
        .mj-network-ui {
            display: none;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #10a37f;
            margin-left: 10px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid rgba(16, 163, 127, 0.3);
        }

        .nav-item.active {
            background: rgba(16, 163, 127, 0.2);
            border: 1px solid #10a37f;
            color: #10a37f;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .user-profile {
            margin-top: auto;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #10a37f, #1e9e70);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-details h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-status {
            font-size: 12px;
            color: #888;
        }

        .status-online {
            color: #10a37f;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            height: 70px;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(20px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 16px;
        }

        /* Network Stats */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #10a37f;
        }

        /* Chat Interface */
        .chat-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            max-width: 70%;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-bubble {
            background: rgba(16, 163, 127, 0.2);
            border: 1px solid rgba(16, 163, 127, 0.3);
            border-radius: 18px;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.sent .message-bubble {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .message-info {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        .message.received .message-info {
            text-align: left;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: #10a37f;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #10a37f;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Logout button */
        .logout-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #e53e3e;
        }
    </style>
</head>
<body>
    <!-- Authentication Interface -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1 class="auth-title">MJ Network</h1>
                <p class="auth-subtitle">Advanced AI Companion System</p>
            </div>

            <div id="statusMessage"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="btn-primary" id="loginButton">
                        Sign In
                    </button>
                </form>
                <div class="auth-switch">
                    Don't have an account? <a onclick="showRegister()">Sign up</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <form id="registerFormElement">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="btn-primary" id="registerButton">
                        Create Account
                    </button>
                </form>
                <div class="auth-switch">
                    Already have an account? <a onclick="showLogin()">Sign in</a>
                </div>
            </div>
        </div>
    </div>

    <!-- MJ Network UI -->
    <div id="mjNetworkUI" class="mj-network-ui">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div style="width: 32px; height: 32px; background: linear-gradient(45deg, #10a37f, #1e9e70); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">MJ</div>
                <div class="logo-text">Network</div>
            </div>

            <nav>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    <span>Dashboard</span>
                </div>

                <div class="nav-item" onclick="showSection('chat')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                        <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                    </svg>
                    <span>MJ Chat</span>
                </div>

                <div class="nav-item" onclick="showSection('friends')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    <span>Friends</span>
                </div>

                <div class="nav-item" onclick="showSection('network')">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                    </svg>
                    <span>MJ Network</span>
                </div>
            </nav>

            <div class="user-profile">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h4 id="userName">Loading...</h4>
                        <div class="user-status status-online" id="userStatus">Online</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()" style="margin-top: 12px; width: 100%;">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="header-title" id="headerTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="alert('Add Friend feature coming soon!')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
                        </svg>
                        Add Friend
                    </button>
                    <button class="btn btn-primary" onclick="startDiscovery()">
                        <div class="loading" id="discoveryLoading" style="display: none;"></div>
                        <span id="discoveryText">Start Discovery</span>
                    </button>
                </div>
            </div>

            <div class="content">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="dashboard-grid">
                        <!-- Network Stats -->
                        <div class="dashboard-card">
                            <h3 class="card-title">🌐 Network Status</h3>
                            <p class="card-subtitle">Your MJ network statistics</p>
                            <div class="stat-item">
                                <span>Total Friends</span>
                                <span class="stat-value" id="totalFriends">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Online Friends</span>
                                <span class="stat-value" id="onlineFriends">0</span>
                            </div>
                            <div class="stat-item">
                                <span>MJ Conversations</span>
                                <span class="stat-value" id="mjConversations">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Messages Exchanged</span>
                                <span class="stat-value" id="totalMessages">0</span>
                            </div>
                        </div>

                        <!-- Welcome Card -->
                        <div class="dashboard-card">
                            <h3 class="card-title">🤖 Welcome to MJ Network!</h3>
                            <p class="card-subtitle">Your AI companion network is ready</p>
                            <p style="font-size: 14px; line-height: 1.6; color: #ccc; margin-bottom: 20px;">
                                Your MJ can now communicate with other MJ instances when you're offline, 
                                maintaining relationships and sharing updates based on your privacy settings.
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button class="btn btn-secondary" onclick="showSection('chat')">Chat with Your MJ</button>
                                <button class="btn btn-secondary" onclick="initializeMJRegistry()">Initialize MJ Network</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Section -->
                <div id="chat-section" class="section" style="display: none;">
                    <div class="chat-container" style="display: flex;">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message received">
                                <div class="message-bubble">
                                    Hey! I'm MJ, your AI companion. I'm now connected to the MJ Network, so I can talk to other MJs when you're offline and share updates with your friends (based on your privacy settings). What would you like to chat about?
                                </div>
                                <div class="message-info">MJ • Now</div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chatInput" placeholder="Message MJ..." rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Friends Section -->
                <div id="friends-section" class="section" style="display: none;">
                    <div class="dashboard-card">
                        <h3 class="card-title">👥 Friends & Connections</h3>
                        <p class="card-subtitle">Manage your MJ Network friends</p>
                        <p style="color: #888; font-size: 14px; text-align: center; padding: 40px;">
                            No friends connected yet. Add friends to start building your MJ network!<br><br>
                            <strong>How it works:</strong><br>
                            • Add friends to your MJ network<br>
                            • Your MJs can communicate when you're offline<br>
                            • Privacy controls determine what information is shared<br>
                        </p>
                    </div>
                </div>

                <!-- Network Section -->
                <div id="network-section" class="section" style="display: none;">
                    <div class="dashboard-card">
                        <h3 class="card-title">🌐 MJ Network Architecture</h3>
                        <p class="card-subtitle">Understanding the MJ Network system</p>
                        <div style="color: #ccc; font-size: 14px; line-height: 1.8;">
                            <h4 style="color: #10a37f; margin: 20px 0 10px;">🤖 What is MJ Network?</h4>
                            <p>MJ Network enables AI companions to communicate with each other on behalf of their users, creating a true social network of AI instances.</p>

                            <h4 style="color: #10a37f; margin: 20px 0 10px;">🔐 Privacy-Aware Communication</h4>
                            <p>Based on your relationship settings (friend, family, colleague), your MJ shares appropriate information:</p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li><strong>Friends:</strong> General mood, activities, interests</li>
                                <li><strong>Family:</strong> Detailed updates, health, location</li>
                                <li><strong>Colleagues:</strong> Work status only</li>
                            </ul>

                            <h4 style="color: #10a37f; margin: 20px 0 10px;">📱 Offline Communication</h4>
                            <p>When you're away, your MJ can:</p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>Respond to check-ins from friends' MJs</li>
                                <li>Share your general status and mood</li>
                                <li>Schedule conversations for when you return</li>
                                <li>Maintain relationships automatically</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        let accessToken = localStorage.getItem('access_token');
        let ws = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            if (accessToken) {
                checkAuth();
            } else {
                showAuthInterface();
            }
        });

        function setupEventListeners() {
            // Form submissions
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('registerFormElement').addEventListener('submit', handleRegister);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = type === 'error' ? 'error-message' : 'success-message';
            statusDiv.textContent = message;
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        function clearStatus() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = '';
            statusDiv.className = '';
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearStatus();
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearStatus();
        }

        async function handleRegister(e) {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            const originalText = button.textContent;
            
            button.textContent = 'Creating Account...';
            button.disabled = true;

            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showStatus('Account created successfully! Logging you in...', 'success');
                    
                    // Auto-login after successful registration
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    
                    setTimeout(async () => {
                        await checkAuth();
                    }, 1000);
                } else {
                    showStatus(data.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showStatus('Network error. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const button = document.getElementById('loginButton');
            const originalText = button.textContent;
            
            button.textContent = 'Signing In...';
            button.disabled = true;

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    showStatus('Login successful!', 'success');
                    
                    setTimeout(async () => {
                        await checkAuth();
                    }, 1000);
                } else {
                    showStatus(data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('Network error. Please try again.', 'error');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/api/v1/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    console.log('✅ Authentication successful:', currentUser);
                    showMJNetworkUI();
                    await loadDashboardData();
                    setupChatInput();
                    connectWebSocket();
                } else {
                    console.log('❌ Authentication failed, clearing token');
                    localStorage.removeItem('access_token');
                    accessToken = null;
                    showAuthInterface();
                }
            } catch (error) {
                console.error('❌ Auth check failed:', error);
                showAuthInterface();
            }
        }

        function showAuthInterface() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mjNetworkUI').style.display = 'none';
        }

        function showMJNetworkUI() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mjNetworkUI').style.display = 'block';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userAvatar').textContent = currentUser.username[0].toUpperCase();
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            // Update header title
            const titles = {
                'dashboard': 'Dashboard',
                'chat': 'Chat with MJ',
                'friends': 'Friends & Connections',
                'network': 'MJ Network'
            };
            document.getElementById('headerTitle').textContent = titles[sectionName];
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_URL}/api/v1/mj-network/registry/status`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalFriends').textContent = data.friends_count || 0;
                    document.getElementById('onlineFriends').textContent = Math.floor(data.friends_count * 0.3) || 0;
                    document.getElementById('mjConversations').textContent = data.active_conversations || 0;
                    document.getElementById('totalMessages').textContent = data.pending_messages || 0;
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        // Initialize MJ Registry
        async function initializeMJRegistry() {
            try {
                const response = await fetch(`${API_URL}/api/v1/mj-network/registry/initialize`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    showStatus('MJ Network initialized successfully!', 'success');
                    await loadDashboardData();
                } else {
                    const data = await response.json();
                    showStatus(data.detail || 'Failed to initialize MJ Network', 'error');
                }
            } catch (error) {
                console.error('Failed to initialize MJ registry:', error);
                showStatus('Network error. Please try again.', 'error');
            }
        }

        // Start Discovery
        async function startDiscovery() {
            const loadingEl = document.getElementById('discoveryLoading');
            const textEl = document.getElementById('discoveryText');
            
            loadingEl.style.display = 'inline-block';
            textEl.textContent = 'Discovering...';
            
            try {
                const response = await fetch(`${API_URL}/api/v1/network/discovery/start`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                    if (response.ok) {
                        textEl.textContent = 'Discovery Active';
                    } else {
                        textEl.textContent = 'Start Discovery';
                    }
                }, 2000);
            } catch (error) {
                console.error('Discovery failed:', error);
                loadingEl.style.display = 'none';
                textEl.textContent = 'Start Discovery';
            }
        }

        // Chat functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'sent');
            input.value = '';
            
            // Send via WebSocket if connected
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    message: message
                }));
            } else {
                // Fallback: simulate response
                setTimeout(() => {
                    addMessageToChat("I received your message, but I'm having connection issues. Let me try to reconnect...", 'received');
                }, 1000);
            }
        }

        function addMessageToChat(text, type) {
            const chatMessages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            message.innerHTML = `
                <div class="message-bubble">${text}</div>
                <div class="message-info">${type === 'sent' ? 'You' : 'MJ'} • ${time}</div>
            `;
            
            chatMessages.appendChild(message);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // WebSocket connection
        function connectWebSocket() {
            if (!currentUser) return;
            
            try {
                const wsUrl = `ws://localhost:8000/ws/${currentUser.id}`;
                console.log('🌐 Connecting to WebSocket:', wsUrl);
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('✅ WebSocket connected');
                };
                
                ws.onmessage = (event) => {
                    console.log('📨 WebSocket message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'message' && data.content) {
                            addMessageToChat(data.content, 'received');
                        }
                    } catch (error) {
                        console.error('❌ Error parsing WebSocket message:', error);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('❌ WebSocket error:', error);
                };
                
                ws.onclose = () => {
                    console.log('🔌 WebSocket disconnected');
                    setTimeout(connectWebSocket, 5000);
                };
            } catch (error) {
                console.error('❌ WebSocket connection failed:', error);
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            accessToken = null;
            currentUser = null;
            if (ws) {
                ws.close();
                ws = null;
            }
            showAuthInterface();
        }
    </script>
</body>
</html>